<!DOCTYPE html>
<html lang="en" class="light">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>UnitMaster Ultimate</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    fontFamily: {
                        sans: ['"Plus Jakarta Sans"', 'sans-serif'],
                    },
                    colors: {
                        brand: {
                            50: 'var(--brand-50)',
                            100: 'var(--brand-100)',
                            200: 'var(--brand-200)',
                            500: 'var(--brand-500)',
                            600: 'var(--brand-600)',
                            700: 'var(--brand-700)',
                            900: 'var(--brand-900)',
                        },
                        dark: {
                            bg: 'var(--dark-bg)',
                            card: 'var(--dark-card)',
                            input: '#334155',
                            text: '#f8fafc',
                        }
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.4s ease-out',
                        'slide-up': 'slideUp 0.5s cubic-bezier(0.16, 1, 0.3, 1)',
                        'pop': 'pop 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275)',
                        'shake': 'shake 0.5s cubic-bezier(.36,.07,.19,.97) both',
                        'gradient-x': 'gradientX 15s ease infinite',
                    },
                    keyframes: {
                        fadeIn: { '0%': { opacity: '0' }, '100%': { opacity: '1' } },
                        slideUp: { '0%': { transform: 'translateY(30px)', opacity: '0' }, '100%': { transform: 'translateY(0)', opacity: '1' } },
                        pop: { '0%': { transform: 'scale(0.9)' }, '100%': { transform: 'scale(1)' } },
                        shake: {
                            '10%, 90%': { transform: 'translate3d(-1px, 0, 0)' },
                            '20%, 80%': { transform: 'translate3d(2px, 0, 0)' },
                            '30%, 50%, 70%': { transform: 'translate3d(-4px, 0, 0)' },
                            '40%, 60%': { transform: 'translate3d(4px, 0, 0)' }
                        },
                        gradientX: {
                            '0%, 100%': { 'background-position': '0% 50%' },
                            '50%': { 'background-position': '100% 50%' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        :root {
            --brand-50: #eff6ff; --brand-100: #dbeafe; --brand-200: #bfdbfe;
            --brand-500: #3b82f6; --brand-600: #2563eb; --brand-700: #1d4ed8; --brand-900: #1e3a8a;
            
            /* Default Dark Mode */
            --dark-bg: #0f172a;
            --dark-card: #1e293b;
        }

        /* AMOLED Mode Overrides */
        body.amoled-mode {
            --dark-bg: #000000;
            --dark-card: #121212;
        }

        /* Zen Mode Background */
        body.zen-mode {
            background: linear-gradient(-45deg, #ee7752, #e73c7e, #23a6d5, #23d5ab);
            background-size: 400% 400%;
            animation: gradientX 15s ease infinite;
        }
        body.zen-mode.dark {
            background: linear-gradient(-45deg, #1a1a2e, #16213e, #0f3460, #222222);
            background-size: 400% 400%;
        }

        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .dark ::-webkit-scrollbar-thumb { background: #475569; }
        
        .glass-panel {
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-bottom: 1px solid rgba(226, 232, 240, 0.6);
        }
        .dark .glass-panel {
            background: rgba(15, 23, 42, 0.9);
            border-bottom: 1px solid rgba(51, 65, 85, 0.6);
        }
        .amoled-mode .glass-panel {
            background: rgba(0, 0, 0, 0.9);
            border-bottom: 1px solid rgba(51, 51, 51, 0.6);
        }
        body.zen-mode .glass-panel, body.zen-mode .category-card {
            background: rgba(255, 255, 255, 0.85);
        }
        body.zen-mode.dark .glass-panel, body.zen-mode.dark .category-card {
            background: rgba(15, 23, 42, 0.85);
        }

        #focusOverlay {
            pointer-events: none; opacity: 0; transition: opacity 0.5s ease;
        }
        body.focus-mode #focusOverlay { pointer-events: auto; opacity: 1; }
        body.focus-mode .focus-target { z-index: 60; position: relative; box-shadow: 0 0 0 100vw rgba(0,0,0,0.85); }

        .category-card:hover { transform: translateY(-4px); }
        .star-active { color: #f59e0b; transform: scale(1.1); }
        
        .kbd-key {
            display: inline-block; padding: 0.15rem 0.4rem; font-size: 0.7rem;
            color: #64748b; background-color: #f1f5f9; border: 1px solid #cbd5e1;
            border-radius: 0.25rem; border-bottom-width: 2px;
        }
        .dark .kbd-key { background-color: #334155; color: #cbd5e1; border-color: #475569; }

        .calc-btn { height: 48px; border-radius: 12px; font-weight: 600; transition: all 0.1s; }
        .calc-btn:active { transform: scale(0.95); }
    </style>
</head>
<body class="bg-slate-50 dark:bg-dark-bg text-slate-800 dark:text-dark-text min-h-screen flex flex-col font-sans transition-colors duration-300 overflow-x-hidden">

    <!-- Focus Mode Overlay -->
    <div id="focusOverlay" class="fixed inset-0 bg-black/80 z-50 flex items-start justify-center pt-10">
        <button onclick="toggleFocusMode()" class="text-white/70 hover:text-white flex items-center gap-2 px-4 py-2 rounded-full border border-white/20 bg-black/50 backdrop-blur-md">
            <i class="fa-solid fa-expand"></i> Exit Focus Mode
        </button>
    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="fixed inset-0 z-[70] hidden">
        <div class="absolute inset-0 bg-black/40 backdrop-blur-sm" onclick="toggleSettings()"></div>
        <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-[90%] max-w-sm bg-white dark:bg-dark-card rounded-3xl p-6 shadow-2xl animate-pop border border-slate-100 dark:border-slate-700 max-h-[90vh] overflow-y-auto">
            <h3 class="text-xl font-bold mb-6 dark:text-white flex items-center justify-between">
                Settings 
                <button onclick="toggleSettings()" class="text-slate-400 hover:text-slate-600"><i class="fa-solid fa-xmark"></i></button>
            </h3>
            
            <div class="space-y-6">
                <!-- Theme Color -->
                <div>
                    <label class="block text-sm font-bold text-slate-500 dark:text-slate-400 mb-3">Theme Color</label>
                    <div class="flex gap-3">
                        <button onclick="setThemeColor('blue')" class="w-10 h-10 rounded-full bg-blue-500 ring-offset-2 focus:ring-2 transition-transform hover:scale-110"></button>
                        <button onclick="setThemeColor('purple')" class="w-10 h-10 rounded-full bg-purple-500 ring-offset-2 focus:ring-2 transition-transform hover:scale-110"></button>
                        <button onclick="setThemeColor('emerald')" class="w-10 h-10 rounded-full bg-emerald-500 ring-offset-2 focus:ring-2 transition-transform hover:scale-110"></button>
                        <button onclick="setThemeColor('orange')" class="w-10 h-10 rounded-full bg-orange-500 ring-offset-2 focus:ring-2 transition-transform hover:scale-110"></button>
                    </div>
                </div>

                 <!-- Toggles -->
                 <div class="space-y-3">
                    <label class="block text-sm font-bold text-slate-500 dark:text-slate-400 mb-2">Experience</label>
                    
                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-slate-700 dark:text-slate-200">Sound Effects</span>
                        <button onclick="toggleSound()" id="soundToggleBtn" class="w-11 h-6 bg-slate-200 rounded-full relative transition-colors focus:outline-none">
                            <div class="w-4 h-4 bg-white rounded-full absolute top-1 left-1 transition-transform transform"></div>
                        </button>
                    </div>

                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-slate-700 dark:text-slate-200">AMOLED Black</span>
                        <button onclick="toggleAmoled()" id="amoledToggleBtn" class="w-11 h-6 bg-slate-200 rounded-full relative transition-colors focus:outline-none">
                            <div class="w-4 h-4 bg-white rounded-full absolute top-1 left-1 transition-transform transform"></div>
                        </button>
                    </div>

                    <div class="flex items-center justify-between">
                        <span class="text-sm font-medium text-slate-700 dark:text-slate-200 flex items-center gap-2"><i class="fa-solid fa-wind text-brand-500"></i> Zen Mode</span>
                        <button onclick="toggleZen()" id="zenToggleBtn" class="w-11 h-6 bg-slate-200 rounded-full relative transition-colors focus:outline-none">
                            <div class="w-4 h-4 bg-white rounded-full absolute top-1 left-1 transition-transform transform"></div>
                        </button>
                    </div>
                </div>

                <!-- Precision -->
                <div>
                    <label class="block text-sm font-bold text-slate-500 dark:text-slate-400 mb-3">Precision</label>
                    <div class="grid grid-cols-4 gap-2">
                        <button onclick="setPrecision('auto')" class="precision-btn px-2 py-2.5 rounded-xl border text-xs font-semibold hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors" data-val="auto">Auto</button>
                        <button onclick="setPrecision(2)" class="precision-btn px-2 py-2.5 rounded-xl border text-xs font-semibold hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors" data-val="2">.00</button>
                        <button onclick="setPrecision(4)" class="precision-btn px-2 py-2.5 rounded-xl border text-xs font-semibold hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors" data-val="4">.0000</button>
                        <button onclick="setPrecision(6)" class="precision-btn px-2 py-2.5 rounded-xl border text-xs font-semibold hover:bg-slate-50 dark:hover:bg-slate-700 transition-colors" data-val="6">High</button>
                    </div>
                </div>

                 <!-- View Options -->
                 <div>
                    <label class="block text-sm font-bold text-slate-500 dark:text-slate-400 mb-3">View Options</label>
                    <button onclick="toggleFullScreen()" class="w-full py-2.5 rounded-xl border border-slate-200 dark:border-slate-700 hover:bg-slate-50 dark:hover:bg-slate-800 text-sm font-semibold text-slate-700 dark:text-slate-300 transition-colors flex items-center justify-center gap-2">
                        <i class="fa-solid fa-expand"></i> Toggle Full Screen
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Calculator Modal -->
    <div id="calculatorModal" class="fixed inset-0 z-[60] hidden pointer-events-none">
        <div class="pointer-events-auto absolute bottom-4 right-4 sm:bottom-8 sm:right-8 w-[300px] bg-white dark:bg-dark-card rounded-3xl shadow-2xl border border-slate-200 dark:border-slate-700 animate-slide-up overflow-hidden flex flex-col">
            <div class="bg-brand-500 p-4 flex justify-between items-center text-white cursor-grab active:cursor-grabbing" id="calcHeader">
                <span class="font-bold"><i class="fa-solid fa-calculator mr-2"></i>Calculator</span>
                <button onclick="toggleCalculator()" class="hover:bg-white/20 rounded-full w-8 h-8 flex items-center justify-center"><i class="fa-solid fa-xmark"></i></button>
            </div>
            <div class="p-4 bg-slate-50 dark:bg-slate-800">
                <input type="text" id="calcDisplay" readonly class="w-full bg-transparent text-right text-3xl font-bold mb-4 outline-none text-slate-800 dark:text-white" value="0">
                <div class="grid grid-cols-4 gap-2">
                    <button onclick="calcClear()" class="calc-btn bg-red-100 text-red-600 dark:bg-red-900/30 dark:text-red-400">C</button>
                    <button onclick="calcAppend('(')" class="calc-btn bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300">(</button>
                    <button onclick="calcAppend(')')" class="calc-btn bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300">)</button>
                    <button onclick="calcAppend('/')" class="calc-btn bg-brand-100 text-brand-700 dark:bg-brand-900/30 dark:text-brand-400">÷</button>
                    <button onclick="calcAppend('7')" class="calc-btn bg-white dark:bg-slate-600 shadow-sm border border-slate-100 dark:border-slate-500">7</button>
                    <button onclick="calcAppend('8')" class="calc-btn bg-white dark:bg-slate-600 shadow-sm border border-slate-100 dark:border-slate-500">8</button>
                    <button onclick="calcAppend('9')" class="calc-btn bg-white dark:bg-slate-600 shadow-sm border border-slate-100 dark:border-slate-500">9</button>
                    <button onclick="calcAppend('*')" class="calc-btn bg-brand-100 text-brand-700 dark:bg-brand-900/30 dark:text-brand-400">×</button>
                    <button onclick="calcAppend('4')" class="calc-btn bg-white dark:bg-slate-600 shadow-sm border border-slate-100 dark:border-slate-500">4</button>
                    <button onclick="calcAppend('5')" class="calc-btn bg-white dark:bg-slate-600 shadow-sm border border-slate-100 dark:border-slate-500">5</button>
                    <button onclick="calcAppend('6')" class="calc-btn bg-white dark:bg-slate-600 shadow-sm border border-slate-100 dark:border-slate-500">6</button>
                    <button onclick="calcAppend('-')" class="calc-btn bg-brand-100 text-brand-700 dark:bg-brand-900/30 dark:text-brand-400">−</button>
                    <button onclick="calcAppend('1')" class="calc-btn bg-white dark:bg-slate-600 shadow-sm border border-slate-100 dark:border-slate-500">1</button>
                    <button onclick="calcAppend('2')" class="calc-btn bg-white dark:bg-slate-600 shadow-sm border border-slate-100 dark:border-slate-500">2</button>
                    <button onclick="calcAppend('3')" class="calc-btn bg-white dark:bg-slate-600 shadow-sm border border-slate-100 dark:border-slate-500">3</button>
                    <button onclick="calcAppend('+')" class="calc-btn bg-brand-100 text-brand-700 dark:bg-brand-900/30 dark:text-brand-400">+</button>
                    <button onclick="calcAppend('0')" class="calc-btn col-span-2 bg-white dark:bg-slate-600 shadow-sm border border-slate-100 dark:border-slate-500">0</button>
                    <button onclick="calcAppend('.')" class="calc-btn bg-white dark:bg-slate-600 shadow-sm border border-slate-100 dark:border-slate-500">.</button>
                    <button onclick="calcResult()" class="calc-btn bg-brand-600 text-white shadow-lg shadow-brand-500/30">=</button>
                </div>
                <button onclick="toggleCalculator()" class="w-full mt-3 py-2.5 rounded-xl bg-slate-200 dark:bg-slate-700 text-slate-600 dark:text-slate-300 font-bold hover:bg-slate-300 dark:hover:bg-slate-600 transition-colors flex items-center justify-center gap-2">
                    <i class="fa-solid fa-check"></i> Done & Close
                </button>
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <header class="sticky top-0 z-50 glass-panel shadow-sm transition-all duration-500">
        <div class="max-w-7xl mx-auto px-4 h-16 flex items-center justify-between">
            <div class="flex items-center gap-2 cursor-pointer group" onclick="resetToHome()">
                <div class="bg-brand-600 text-white p-2 rounded-xl shadow-lg shadow-brand-500/30 group-hover:scale-105 transition-transform">
                    <i class="fa-solid fa-layer-group text-lg"></i>
                </div>
                <h1 class="text-xl sm:text-2xl font-bold tracking-tight text-slate-900 dark:text-white">Unit<span class="text-brand-600 dark:text-brand-500">Master</span></h1>
            </div>
            
            <div class="flex items-center gap-2 sm:gap-3">
                <button onclick="toggleCalculator()" class="hidden sm:flex w-10 h-10 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-300 transition-all items-center justify-center" title="Calculator (Shift+C)">
                    <i class="fa-solid fa-calculator"></i>
                </button>
                <button onclick="toggleSettings()" class="w-10 h-10 rounded-full hover:bg-slate-100 dark:hover:bg-slate-800 text-slate-600 dark:text-slate-300 transition-all flex items-center justify-center" title="Settings">
                    <i class="fa-solid fa-sliders text-lg"></i>
                </button>
                <button onclick="toggleThemeMode()" class="w-10 h-10 rounded-full bg-slate-100 dark:bg-slate-800 text-slate-600 dark:text-slate-300 hover:bg-brand-100 dark:hover:bg-slate-700 hover:text-brand-600 transition-all flex items-center justify-center">
                    <i id="themeIcon" class="fa-solid fa-moon text-lg"></i>
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow flex flex-col items-center justify-start pt-6 sm:pt-10 pb-12 px-4 w-full max-w-7xl mx-auto">
        
        <!-- Search & Hero -->
        <div id="heroSection" class="w-full max-w-3xl mb-8 sm:mb-12 text-center space-y-4 sm:space-y-6 animate-fade-in">
            <h2 class="text-3xl sm:text-5xl font-extrabold text-slate-900 dark:text-white tracking-tight leading-tight">
                Convert <span class="text-transparent bg-clip-text bg-gradient-to-r from-brand-600 to-indigo-600 dark:from-brand-400 dark:to-indigo-400">Everything.</span>
            </h2>
            <p class="text-slate-500 dark:text-slate-400 text-base sm:text-lg max-w-xl mx-auto">Ultimate conversion tool. Now with Power, Flow, Angle, and Radiation.</p>
            
            <div class="relative max-w-md mx-auto group z-0">
                <div class="absolute inset-y-0 left-0 pl-4 flex items-center pointer-events-none">
                    <i class="fa-solid fa-magnifying-glass text-slate-400 group-focus-within:text-brand-500 transition-colors"></i>
                </div>
                <input type="text" id="searchInput" 
                    class="block w-full pl-11 pr-4 py-3.5 sm:py-4 border border-slate-200 dark:border-slate-700 rounded-2xl leading-5 bg-white dark:bg-slate-800 text-slate-900 dark:text-white placeholder-slate-400 focus:outline-none focus:ring-4 focus:ring-brand-500/20 focus:border-brand-500 shadow-xl shadow-slate-200/50 dark:shadow-none transition-all"
                    placeholder="Search (e.g. Watts, Degrees, Flow)...">
            </div>
        </div>

        <!-- Categories Grid -->
        <div id="categoriesGrid" class="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-3 sm:gap-6 w-full animate-slide-up pb-10">
            <!-- Categories injected by JS -->
        </div>

        <!-- Converter Interface -->
        <div id="converterSection" class="hidden w-full max-w-5xl animate-slide-up flex flex-col lg:flex-row gap-6 transition-all duration-500">
            
            <!-- Main Converter Card -->
            <div class="focus-target w-full lg:w-2/3 bg-white dark:bg-dark-card rounded-3xl shadow-2xl shadow-slate-200/50 dark:shadow-none border border-slate-100 dark:border-slate-700 overflow-hidden relative flex flex-col">
                
                <!-- Card Header -->
                <div class="bg-slate-50/80 dark:bg-slate-800/50 border-b border-slate-100 dark:border-slate-700 p-4 sm:p-6 flex items-center justify-between backdrop-blur-sm sticky top-0 z-10">
                    <div class="flex items-center gap-3">
                        <button onclick="resetToHome()" class="p-2 -ml-2 rounded-xl hover:bg-slate-200 dark:hover:bg-slate-700 text-slate-500 dark:text-slate-400 transition-colors group" title="Back">
                            <i class="fa-solid fa-arrow-left text-lg group-hover:-translate-x-1 transition-transform"></i>
                        </button>
                        <div class="flex items-center gap-3">
                            <div id="activeIcon" class="w-10 h-10 sm:w-12 sm:h-12 rounded-xl bg-brand-100 dark:bg-brand-900/30 text-brand-600 dark:text-brand-400 flex items-center justify-center text-xl sm:text-2xl shadow-inner"></div>
                            <div>
                                <h3 id="activeCategoryTitle" class="text-lg sm:text-xl font-bold text-slate-900 dark:text-white"></h3>
                                <p class="text-xs font-bold text-brand-600 dark:text-brand-400 uppercase tracking-wide">Converter</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex gap-2">
                         <button onclick="toggleFocusMode()" class="p-2 text-slate-400 hover:text-brand-500 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700" title="Focus Mode"><i class="fa-solid fa-expand"></i></button>
                         <button onclick="toggleCalculator()" class="lg:hidden p-2 text-slate-400 hover:text-brand-500 rounded-lg hover:bg-slate-100 dark:hover:bg-slate-700"><i class="fa-solid fa-calculator"></i></button>
                    </div>
                </div>

                <!-- Inputs Area -->
                <div class="p-4 sm:p-8 flex-grow">
                    <div class="grid grid-cols-1 gap-6 items-center">
                        
                        <!-- From Section -->
                        <div id="fromContainer" class="bg-slate-50 dark:bg-slate-800 p-5 rounded-2xl border border-slate-200 dark:border-slate-700 focus-within:border-brand-500 dark:focus-within:border-brand-500 focus-within:ring-1 focus-within:ring-brand-500 transition-all relative">
                             <div class="flex justify-between items-center mb-2">
                                <label class="text-xs font-bold text-slate-500 dark:text-slate-400 uppercase tracking-wider">From (Type Math: 2*pi)</label>
                                <button id="micBtn" onclick="toggleVoiceInput()" class="text-slate-400 hover:text-red-500 dark:hover:text-red-400 transition-colors" title="Dictate Value"><i class="fa-solid fa-microphone"></i></button>
                            </div>
                            <div class="flex gap-4">
                                <input type="text" id="fromValue" value="1" class="w-2/3 text-3xl sm:text-4xl font-bold bg-transparent border-none p-0 focus:ring-0 text-slate-900 dark:text-white placeholder-slate-300 dark:placeholder-slate-600 tracking-tight" placeholder="0">
                                <div class="w-1/3 relative min-w-[100px]">
                                    <select id="fromUnit" class="w-full appearance-none bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-700 dark:text-slate-200 py-3 pl-3 pr-8 rounded-xl focus:outline-none focus:border-brand-500 font-medium cursor-pointer text-sm sm:text-base shadow-sm truncate"></select>
                                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500"><i class="fa-solid fa-chevron-down text-xs"></i></div>
                                </div>
                            </div>
                        </div>

                        <!-- Swap Icon -->
                        <div class="flex justify-center -my-4 z-10">
                             <button onclick="swapUnits()" class="w-10 h-10 rounded-full bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 shadow-lg text-brand-600 dark:text-brand-400 flex items-center justify-center hover:rotate-180 transition-transform"><i class="fa-solid fa-arrow-up-down"></i></button>
                        </div>

                        <!-- To Section -->
                        <div class="bg-brand-50/50 dark:bg-slate-800/50 p-5 rounded-2xl border border-brand-100 dark:border-slate-700 transition-all relative">
                            <label class="flex justify-between text-xs font-bold text-brand-700 dark:text-brand-400 uppercase tracking-wider mb-2">
                                <span>To</span>
                                <span class="text-[10px] bg-brand-100 dark:bg-brand-900/30 text-brand-700 dark:text-brand-300 px-2 py-0.5 rounded-full">Result</span>
                            </label>
                            
                            <div class="flex gap-4 mb-3">
                                <input type="text" id="toValue" readonly class="w-2/3 text-3xl sm:text-4xl font-bold bg-transparent border-none p-0 focus:ring-0 text-brand-900 dark:text-white placeholder-slate-300 tracking-tight truncate" placeholder="0">
                                <div class="w-1/3 relative min-w-[100px]">
                                    <select id="toUnit" class="w-full appearance-none bg-white dark:bg-slate-700 border border-slate-200 dark:border-slate-600 text-slate-700 dark:text-slate-200 py-3 pl-3 pr-8 rounded-xl focus:outline-none focus:border-brand-500 font-medium cursor-pointer text-sm sm:text-base shadow-sm truncate"></select>
                                    <div class="pointer-events-none absolute inset-y-0 right-0 flex items-center px-2 text-slate-500"><i class="fa-solid fa-chevron-down text-xs"></i></div>
                                </div>
                            </div>

                            <!-- Actions Toolbar -->
                            <div class="flex items-center gap-1 sm:gap-2 pt-2 border-t border-brand-100 dark:border-slate-700/50">
                                <button onclick="copyToClipboard()" class="flex-1 py-2 rounded-lg hover:bg-white dark:hover:bg-slate-700 text-slate-500 hover:text-brand-600 transition-colors text-sm font-medium"><i class="fa-regular fa-copy mr-1"></i> Copy</button>
                                <button onclick="speakResult()" class="flex-1 py-2 rounded-lg hover:bg-white dark:hover:bg-slate-700 text-slate-500 hover:text-brand-600 transition-colors text-sm font-medium"><i class="fa-solid fa-volume-high mr-1"></i> Speak</button>
                                <button onclick="useResultAsInput()" class="flex-1 py-2 rounded-lg hover:bg-white dark:hover:bg-slate-700 text-slate-500 hover:text-brand-600 transition-colors text-sm font-medium"><i class="fa-solid fa-arrow-up mr-1"></i> Use</button>
                            </div>
                        </div>
                    </div>

                    <!-- Formula/Info -->
                    <div class="mt-6 p-4 rounded-xl bg-amber-50 dark:bg-amber-900/10 border border-amber-100 dark:border-amber-800/30 text-amber-800 dark:text-amber-200 text-sm flex gap-3 items-start">
                        <i class="fa-solid fa-circle-info mt-1"></i>
                        <p id="conversionInfo" class="opacity-90 font-mono break-words">Formula will appear here.</p>
                    </div>
                </div>
            </div>

            <!-- Sidebar -->
            <div class="w-full lg:w-1/3 flex flex-col gap-6">
                <!-- Quick Compare Table -->
                <div class="bg-white dark:bg-dark-card rounded-3xl shadow-lg border border-slate-100 dark:border-slate-700 flex flex-col h-[300px] lg:h-1/2">
                    <div class="p-4 border-b border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 rounded-t-3xl">
                        <h4 class="font-bold text-slate-800 dark:text-white flex items-center gap-2"><i class="fa-solid fa-list-ul text-brand-500"></i> Quick Compare</h4>
                    </div>
                    <div class="flex-grow overflow-y-auto p-2 scrollbar-thin" id="compareTable"></div>
                </div>

                <!-- History -->
                <div class="bg-white dark:bg-dark-card rounded-3xl shadow-lg border border-slate-100 dark:border-slate-700 flex flex-col h-[300px] lg:h-1/2">
                    <div class="p-4 border-b border-slate-100 dark:border-slate-700 bg-slate-50 dark:bg-slate-800/50 rounded-t-3xl flex justify-between items-center">
                        <h4 class="font-bold text-slate-800 dark:text-white flex items-center gap-2"><i class="fa-solid fa-clock-rotate-left text-brand-500"></i> History</h4>
                        <div class="flex gap-2">
                             <button onclick="copyAllHistory()" class="text-xs font-bold text-brand-600 bg-brand-50 px-2 py-1 rounded hover:bg-brand-100" title="Copy All"><i class="fa-regular fa-copy"></i></button>
                            <button onclick="exportHistory()" class="text-xs font-bold text-brand-600 bg-brand-50 px-2 py-1 rounded hover:bg-brand-100">CSV</button>
                            <button onclick="clearHistory()" class="text-xs text-red-500 hover:text-red-700 px-2 py-1">Clear</button>
                        </div>
                    </div>
                    <div class="flex-grow overflow-y-auto p-2 scrollbar-thin space-y-2" id="historyList"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer class="mt-auto py-8 bg-white dark:bg-dark-card border-t border-slate-200 dark:border-slate-800 transition-colors">
        <div class="max-w-7xl mx-auto px-4 flex flex-col md:flex-row items-center justify-between gap-4">
            <div class="flex flex-col items-center md:items-start">
                <span class="font-bold text-lg text-slate-900 dark:text-white">Unit<span class="text-brand-600">Master</span> Ultimate</span>
                <p class="text-sm text-slate-500 dark:text-slate-400 mt-1">&copy; 2025 UnitMaster Technologies</p>
            </div>
            <div class="flex gap-6 text-slate-500 dark:text-slate-400 text-sm">
                <a href="#" class="hover:text-brand-600 transition-colors">Privacy Policy</a>
                <a href="#" class="hover:text-brand-600 transition-colors">Terms of Service</a>
                <a href="#" class="hover:text-brand-600 transition-colors">Contact</a>
            </div>
        </div>
    </footer>

    <!-- Toast -->
    <div id="toast" class="fixed bottom-6 left-1/2 -translate-x-1/2 z-[80] bg-slate-900 dark:bg-white text-white dark:text-slate-900 px-6 py-3 rounded-full shadow-2xl flex items-center gap-3 font-medium transition-all duration-300 opacity-0 translate-y-10 pointer-events-none">
        <i id="toastIcon" class="fa-solid fa-check-circle text-brand-500"></i>
        <span id="toastMsg">Action successful!</span>
    </div>

    <!-- Logic -->
    <script>
        // --- Configuration & Data ---
        const unitData = {
            length: {
                title: 'Length', icon: 'fa-ruler-combined', color: 'bg-blue-500', base: 'meter',
                units: { meter: 1, kilometer: 0.001, centimeter: 100, millimeter: 1000, mile: 0.000621371, yard: 1.09361, foot: 3.28084, inch: 39.3701, nautical_mile: 0.000539957 }
            },
            weight: {
                title: 'Weight', icon: 'fa-weight-scale', color: 'bg-emerald-500', base: 'kilogram',
                units: { kilogram: 1, gram: 1000, milligram: 1000000, metric_ton: 0.001, pound: 2.20462, ounce: 35.274, stone: 0.157473 }
            },
           
            power: {
                title: 'Power', icon: 'fa-plug', color: 'bg-red-500', base: 'watt',
                units: { watt: 1, kilowatt: 0.001, horsepower: 0.001341, horsepower_metric: 0.001359, btu_hour: 3.412142 }
            },
            flow: {
                title: 'Flow Rate', icon: 'fa-water', color: 'bg-cyan-500', base: 'l_min',
                units: { l_min: 1, gal_min: 0.264172, m3_s: 0.0000166, ft3_s: 0.0005886 }
            },
            angle: {
                title: 'Angle', icon: 'fa-compass', color: 'bg-violet-600', base: 'degree',
                units: { degree: 1, radian: 0.017453, gradian: 1.111111, arcsecond: 3600 }
            },
            radiation: {
                title: 'Radiation', icon: 'fa-radiation', color: 'bg-yellow-600', base: 'gray',
                units: { gray: 1, sievert: 1, rad: 100, rem: 100 }
            },
            text: {
                title: 'Text Tools', icon: 'fa-font', color: 'bg-teal-600', type: 'text',
                desc: 'Case Convert, Reverse',
                units: { text: 'Original', upper: 'UPPERCASE', lower: 'lowercase', title: 'Title Case', camel: 'camelCase', snake: 'snake_case', kebab: 'kebab-case', reverse: 'Reverse' }
            },
            encoding: {
                title: 'Encoding', icon: 'fa-file-code', color: 'bg-slate-600', type: 'encoding',
                desc: 'Base64, URL Encode',
                units: { text: 'Text', base64_enc: 'Base64 Encoded', base64_dec: 'Base64 Decoded', url_enc: 'URL Encoded', url_dec: 'URL Decoded' }
            },
            torque: {
                title: 'Torque', icon: 'fa-wrench', color: 'bg-stone-500', base: 'nm',
                units: { nm: 1, ftlb: 0.737562, kgm: 0.101972, inlb: 8.85074 }
            },
            illuminance: {
                title: 'Light', icon: 'fa-lightbulb', color: 'bg-yellow-400', base: 'lux',
                units: { lux: 1, foot_candle: 0.092903, phot: 0.0001 }
            },
            color: {
                title: 'Color', icon: 'fa-palette', color: 'bg-pink-500', type: 'color',
                desc: 'Hex ↔ RGB ↔ HSL',
                units: { 'hex': 'HEX', 'rgb': 'RGB', 'hsl': 'HSL' }
            },
            morse: {
                title: 'Morse', icon: 'fa-tower-broadcast', color: 'bg-stone-500', type: 'morse',
                desc: 'Text ↔ Morse Code',
                units: { 'text': 'Text', 'morse': 'Morse Code' }
            },
            frequency: {
                title: 'Frequency', icon: 'fa-wave-square', color: 'bg-violet-500', base: 'hertz',
                units: { hertz: 1, kilohertz: 0.001, megahertz: 0.000001, gigahertz: 1e-9, rpm: 60 }
            },
            typography: {
                title: 'Typography', icon: 'fa-text-height', color: 'bg-indigo-600', type: 'typography',
                desc: 'px, rem, em, %, pt (Base 16)',
                units: { 'px': 'Pixels (px)', 'rem': 'REM', 'em': 'EM', 'percent': '%', 'pt': 'Points (pt)' }
            },
            cooking: {
                title: 'Cooking', icon: 'fa-utensils', color: 'bg-amber-500', base: 'ml',
                units: { ml: 1, teaspoon_us: 0.202884, tablespoon_us: 0.067628, cup_us: 0.00422675, pint_us: 0.00211338, quart_us: 0.00105669, gallon_us: 0.000264172 }
            },
            transfer: {
                title: 'Transfer', icon: 'fa-network-wired', color: 'bg-cyan-600', base: 'mbps',
                units: { mbps: 1, gbps: 0.001, mbs: 0.125, gbs: 0.000125 }
            },
            base: {
                title: 'Systems', icon: 'fa-microchip', color: 'bg-slate-500', type: 'base',
                desc: 'Binary, Hex, Decimal, Octal',
                units: { '10': 'Decimal (10)', '2': 'Binary (2)', '16': 'Hexadecimal (16)', '8': 'Octal (8)' }
            },
            roman: {
                title: 'Roman', icon: 'fa-landmark', color: 'bg-amber-600', type: 'roman',
                desc: 'Standard ↔ Roman Numerals',
                units: { 'num': 'Number', 'rom': 'Roman Numeral' }
            },
            fuel: { 
                title: 'Fuel Cons.', icon: 'fa-gas-pump', color: 'bg-rose-500', type: 'fuel',
                desc: 'MPG ↔ L/100km',
                units: { 'mpg_us': 'MPG (US)', 'l_100km': 'L/100km', 'mpg_uk': 'MPG (UK)', 'km_l': 'km/L' }
            },
            temperature: {
                title: 'Temperature', icon: 'fa-temperature-three-quarters', color: 'bg-orange-500', type: 'formula',
                desc: 'Celsius, Fahrenheit'
            },
            currency: {
                title: 'Currency', icon: 'fa-money-bill-wave', color: 'bg-green-600', type: 'currency',
                desc: 'Approx. Rates (USD Base)',
                units: { 'USD': 1, 'EUR': 0.92, 'GBP': 0.79, 'JPY': 148.2, 'CAD': 1.35, 'AUD': 1.53, 'INR': 83.1, 'CNY': 7.19 }
            },
            area: {
                title: 'Area', icon: 'fa-vector-square', color: 'bg-indigo-500', base: 'square_meter',
                units: { square_meter: 1, hectare: 0.0001, acre: 0.000247105, square_foot: 10.7639, square_inch: 1550.0031 }
            },
            speed: {
                title: 'Speed', icon: 'fa-gauge-high', color: 'bg-cyan-500', base: 'meters_per_second',
                units: { meters_per_second: 1, kilometers_per_hour: 3.6, miles_per_hour: 2.23694, knot: 1.94384, mach: 0.002915 }
            },
            time: {
                title: 'Time', icon: 'fa-clock', color: 'bg-teal-500', base: 'second',
                units: { second: 1, minute: 1/60, hour: 1/3600, day: 1/86400, week: 1/604800, year: 1/31536000 }
            },
            digital: {
                title: 'Data', icon: 'fa-hard-drive', color: 'bg-gray-500', base: 'byte',
                units: { bit: 8, byte: 1, kilobyte: 1/1024, megabyte: 1/1048576, gigabyte: 1/1073741824, terabyte: 1/1099511627776 }
            },
            energy: {
                title: 'Energy', icon: 'fa-bolt', color: 'bg-yellow-500', base: 'joule',
                units: { joule: 1, kilojoule: 0.001, calorie: 0.239006, kilocalorie: 0.000239, watt_hour: 0.000277778 }
            },
            pressure: {
                title: 'Pressure', icon: 'fa-compress', color: 'bg-fuchsia-500', base: 'pascal',
                units: { pascal: 1, bar: 0.00001, psi: 0.000145038, atm: 0.0000098692 }
            }
        };

        // --- State ---
        let state = {
            category: null,
            precision: 'auto',
            theme: 'blue',
            sound: localStorage.getItem('soundEnabled') === 'true',
            amoled: localStorage.getItem('amoledMode') === 'true',
            zen: localStorage.getItem('zenMode') === 'true',
            favorites: JSON.parse(localStorage.getItem('unitFavorites') || '[]'),
            history: JSON.parse(localStorage.getItem('unitHistory') || '[]'),
            calculatorOpen: false
        };

        // --- Elements ---
        const els = {
            grid: document.getElementById('categoriesGrid'),
            converter: document.getElementById('converterSection'),
            hero: document.getElementById('heroSection'),
            search: document.getElementById('searchInput'),
            activeTitle: document.getElementById('activeCategoryTitle'),
            activeIcon: document.getElementById('activeIcon'),
            fromVal: document.getElementById('fromValue'),
            fromUnit: document.getElementById('fromUnit'),
            toVal: document.getElementById('toValue'),
            toUnit: document.getElementById('toUnit'),
            info: document.getElementById('conversionInfo'),
            historyList: document.getElementById('historyList'),
            compareTable: document.getElementById('compareTable'),
            themeIcon: document.getElementById('themeIcon'),
            settingsModal: document.getElementById('settingsModal'),
            calcModal: document.getElementById('calculatorModal'),
            calcDisplay: document.getElementById('calcDisplay'),
            soundBtn: document.getElementById('soundToggleBtn'),
            amoledBtn: document.getElementById('amoledToggleBtn'),
            zenBtn: document.getElementById('zenToggleBtn')
        };

        // --- Init ---
        function init() {
            loadState();
            renderCategories();
            setupEvents();
            setupVoice();
            setInterval(showTrivia, 10000);
        }

        function loadState() {
            if (localStorage.themeMode === 'dark' || (!('themeMode' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
                document.documentElement.classList.add('dark');
                els.themeIcon.className = 'fa-solid fa-sun text-lg';
            }
            if (state.amoled) document.body.classList.add('amoled-mode');
            if (state.zen) document.body.classList.add('zen-mode');
            
            const savedColor = localStorage.getItem('brandColor') || 'blue';
            setThemeColor(savedColor);
            state.precision = localStorage.getItem('precision') || 'auto';
            updatePrecisionBtns();
            updateToggleBtns();
            renderHistory();
        }

        // --- Logic: Colors, Morse, Text, Encoding ---
        function convertColor(val, f, t) {
            val = val.trim();
            let r, g, b;
            if (f === 'hex') {
                if (!/^#?([0-9A-F]{3}){1,2}$/i.test(val)) return 'Invalid Hex';
                let hex = val.replace('#', '');
                if (hex.length === 3) hex = hex.split('').map(c => c + c).join('');
                const n = parseInt(hex, 16);
                r = (n >> 16) & 255; g = (n >> 8) & 255; b = n & 255;
            } else if (f === 'rgb') {
                const parts = val.match(/\d+/g);
                if (!parts || parts.length < 3) return 'Invalid RGB';
                [r, g, b] = parts.map(Number);
            } else if (f === 'hsl') {
                 const parts = val.match(/\d+/g);
                 if (!parts || parts.length < 3) return 'Invalid HSL';
                 let h = parts[0]/360, s = parts[1]/100, l = parts[2]/100;
                 if(s===0){ r=g=b=l*255; } else {
                    const q = l<0.5 ? l*(1+s) : l+s-l*s; const p = 2*l-q;
                    r = hue2rgb(p, q, h+1/3)*255; g = hue2rgb(p, q, h)*255; b = hue2rgb(p, q, h-1/3)*255;
                 }
            }
            if (t === 'hex') return "#" + ((1 << 24) + (Math.round(r) << 16) + (Math.round(g) << 8) + Math.round(b)).toString(16).slice(1).toUpperCase();
            else if (t === 'rgb') return `rgb(${Math.round(r)}, ${Math.round(g)}, ${Math.round(b)})`;
            else if (t === 'hsl') {
                r/=255; g/=255; b/=255;
                const max = Math.max(r,g,b), min = Math.min(r,g,b);
                let h, s, l = (max+min)/2;
                if(max===min){ h=s=0; } else {
                    const d = max-min;
                    s = l>0.5 ? d/(2-max-min) : d/(max+min);
                    switch(max){ case r: h=(g-b)/d+(g<b?6:0); break; case g: h=(b-r)/d+2; break; case b: h=(r-g)/d+4; break; }
                    h/=6;
                }
                return `hsl(${Math.round(h*360)}, ${Math.round(s*100)}%, ${Math.round(l*100)}%)`;
            }
        }
        function hue2rgb(p, q, t){ if(t<0) t+=1; if(t>1) t-=1; if(t<1/6) return p+(q-p)*6*t; if(t<1/2) return q; if(t<2/3) return p+(q-p)*(2/3-t)*6; return p; }
        
        const MORSE_MAP = { 'A':'.-', 'B':'-...', 'C':'-.-.', 'D':'-..', 'E':'.', 'F':'..-.', 'G':'--.', 'H':'....', 'I':'..', 'J':'.---', 'K':'-.-', 'L':'.-..', 'M':'--', 'N':'-.', 'O':'---', 'P':'.--.', 'Q':'--.-', 'R':'.-.', 'S':'...', 'T':'-', 'U':'..-', 'V':'...-', 'W':'.--', 'X':'-..-', 'Y':'-.--', 'Z':'--..', '1':'.----', '2':'..---', '3':'...--', '4':'....-', '5':'.....', '6':'-....', '7':'--...', '8':'---..', '9':'----.', '0':'-----', ' ':'/' };
        const REV_MORSE = Object.fromEntries(Object.entries(MORSE_MAP).map(a => a.reverse()));
        function convertMorse(val, f, t) {
            val = val.trim().toUpperCase();
            return (f === 'text') ? val.split('').map(c => MORSE_MAP[c] || c).join(' ') : val.split(' ').map(c => REV_MORSE[c] || c).join('');
        }
        function convertText(val, f, t) {
            if(f !== 'text') return val;
            if(t === 'upper') return val.toUpperCase();
            if(t === 'lower') return val.toLowerCase();
            if(t === 'title') return val.replace(/\w\S*/g, w => w.charAt(0).toUpperCase() + w.substr(1).toLowerCase());
            if(t === 'reverse') return val.split('').reverse().join('');
            if(t === 'camel') return val.replace(/(?:^\w|[A-Z]|\b\w)/g, (word, index) => index === 0 ? word.toLowerCase() : word.toUpperCase()).replace(/\s+/g, '');
            if(t === 'snake') return val.match(/[A-Z]{2,}(?=[A-Z][a-z]+[0-9]*|\b)|[A-Z]?[a-z]+[0-9]*|[A-Z]|[0-9]+/g).map(x => x.toLowerCase()).join('_');
            if(t === 'kebab') return val.match(/[A-Z]{2,}(?=[A-Z][a-z]+[0-9]*|\b)|[A-Z]?[a-z]+[0-9]*|[A-Z]|[0-9]+/g).map(x => x.toLowerCase()).join('-');
            return val;
        }
        function convertEncoding(val, f, t) {
            try {
                if(f === 'text' && t === 'base64_enc') return btoa(val);
                if(f === 'text' && t === 'url_enc') return encodeURIComponent(val);
                if(t === 'base64_dec') return atob(val);
                if(t === 'url_dec') return decodeURIComponent(val);
                return val;
            } catch(e) { return 'Encoding Error'; }
        }

        // --- Main Calculation ---
        function calculate(skipHistory = false) {
            if (!state.category) return;
            
            let rawVal = els.fromVal.value.trim();
            const u1 = els.fromUnit.value;
            const u2 = els.toUnit.value;
            const data = unitData[state.category];
            const complexTypes = ['base','roman','color','morse','text','encoding'];

            // Math Constants & Eval
            if (!complexTypes.includes(data.type)) {
                rawVal = rawVal.replace(/pi/gi, Math.PI).replace(/e/gi, Math.E);
                if (/[\+\-\*\/]/.test(rawVal)) {
                    try {
                        const safeMath = Function('"use strict";return (' + rawVal.replace(/[^-()\d/*+.]/g, '') + ')')();
                        if(!isNaN(safeMath)) rawVal = safeMath.toString();
                    } catch(e){}
                }
            }
            
            let val = parseFloat(rawVal);
            let result = 0;
            let formula = '';
            let valid = true;

            // --- Routing ---
            if (data.type === 'text') { result = convertText(rawVal, u1, u2); formula = 'String Manipulation'; }
            else if (data.type === 'encoding') { result = convertEncoding(rawVal, u1, u2); if(result === 'Encoding Error') valid=false; formula = 'Encoder/Decoder'; }
            else if (data.type === 'color') { result = convertColor(rawVal, u1, u2); if(result.startsWith('Invalid')) valid = false; formula = 'Color Translation'; }
            else if (data.type === 'morse') { result = convertMorse(rawVal, u1, u2); formula = 'Morse Translation'; }
            else if (data.type === 'typography') { const toPx = { px:1, rem:16, em:16, pt:1.333, percent:0.16 }; const pxVal = val * toPx[u1]; result = pxVal / toPx[u2]; formula = `Base 16px assumed`; }
            else if (data.type === 'base') {
                try {
                    const fromBase = parseInt(u1); const toBase = parseInt(u2);
                    const dec = parseInt(rawVal, fromBase);
                    if (isNaN(dec)) throw 'Invalid';
                    result = dec.toString(toBase).toUpperCase();
                    formula = `Base ${fromBase} → Base ${toBase}`;
                } catch { valid = false; }
            } else if (data.type === 'roman') {
                if (u1 === 'num') { if(isNaN(val)) valid=false; else { result = toRoman(val); formula = `Decimal to Roman`; } }
                else { result = fromRoman(rawVal.toUpperCase()); if(!result) valid=false; formula = `Roman to Decimal`; }
            } else if (isNaN(val) && !complexTypes.includes(data.type)) {
                valid = false;
            } else if (data.type === 'formula') { result = convertTemp(val, u1, u2); formula = 'Temp Formula'; }
            else if (data.type === 'fuel') { result = convertFuel(val, u1, u2); formula = 'Fuel Formula'; }
            else { const r1 = data.units[u1], r2 = data.units[u2]; result = (val / r1) * r2; formula = `1 ${formatUnit(u1)} = ${formatNum((1/r1)*r2)} ${formatUnit(u2)}`; }

            if (!valid) {
                shakeInput();
                els.toVal.value = ''; els.info.innerText = 'Invalid Input';
                return;
            }

            // Formatting
            if (complexTypes.includes(data.type)) {
                els.toVal.value = result;
                els.compareTable.innerHTML = ''; 
            } else {
                els.toVal.value = formatRes(result);
                updateCompareTable(val, u1, data);
            }
            els.info.innerText = formula;

            if (!skipHistory) {
                clearTimeout(window.calcTimer);
                window.calcTimer = setTimeout(() => addToHistory(rawVal, u1, els.toVal.value, u2), 2000);
            }
        }

        // --- Helpers ---
        function shakeInput() {
            document.getElementById('fromContainer').classList.remove('animate-shake');
            void document.getElementById('fromContainer').offsetWidth; 
            document.getElementById('fromContainer').classList.add('animate-shake');
            playClick(true); 
        }

        function playClick(isError = false) {
            if (!state.sound) return;
            const ctx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = ctx.createOscillator(); const gain = ctx.createGain();
            osc.connect(gain); gain.connect(ctx.destination);
            osc.type = isError ? 'sawtooth' : 'sine';
            osc.frequency.value = isError ? 150 : 600;
            gain.gain.setValueAtTime(0.05, ctx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, ctx.currentTime + 0.1);
            osc.start(); osc.stop(ctx.currentTime + 0.1);
        }

        const triviaList = [ "Celsius and Fahrenheit meet at -40.", "A 'jiffy' is 1/100th of a second.", "2.54 cm exactly in an inch.", "Light takes 8m 20s to reach Earth." ];
        function showTrivia() { if(!els.converter.classList.contains('hidden') && els.fromVal.value === '') els.info.innerText = "Did you know? " + triviaList[Math.floor(Math.random() * triviaList.length)]; }

        // --- Roman/Temp/Fuel Functions ---
        function toRoman(num) { if (num < 1 || num > 3999) return "Out of range"; const lookup = {M:1000,CM:900,D:500,CD:400,C:100,XC:90,L:50,XL:40,X:10,IX:9,V:5,IV:4,I:1}; let roman = ''; for (let i in lookup) { while (num >= lookup[i]) { roman += i; num -= lookup[i]; } } return roman; }
        function fromRoman(str) { const lookup = {M:1000,D:500,C:100,L:50,X:10,V:5,I:1}; let num = 0; for(let i=0; i<str.length; i++) { let curr = lookup[str[i]], next = lookup[str[i+1]]; if(curr < next) { num += next - curr; i++; } else { num += curr; } } return isNaN(num) ? null : num; }
        function convertTemp(v, f, t) { if(f===t)return v; let c=(f==='Celsius')?v:(f==='Fahrenheit')?(v-32)*5/9:v-273.15; return(t==='Celsius')?c:(t==='Fahrenheit')?(c*9/5)+32:c+273.15;}
        function convertFuel(v, f, t) { if(f===t)return v; let l=0; if(f==='l_100km')l=v;else if(f==='km_l')l=100/v;else l=(f==='mpg_us'?235.215:282.481)/v; if(t==='l_100km')return l; if(t==='km_l')return 100/l; return(t==='mpg_us'?235.215:282.481)/l; }

        // --- UI Updates ---
        function renderCategories(filter = '') {
            els.grid.innerHTML = '';
            const keys = Object.keys(unitData).sort((a,b) => { const aFav = state.favorites.includes(a), bFav = state.favorites.includes(b); return (aFav === bFav) ? a.localeCompare(b) : aFav ? -1 : 1; });
            keys.forEach(key => {
                const data = unitData[key];
                if (!filter || data.title.toLowerCase().includes(filter.toLowerCase()) || (data.desc && data.desc.toLowerCase().includes(filter.toLowerCase()))) {
                    const isFav = state.favorites.includes(key);
                    const card = document.createElement('div');
                    card.className = `category-card relative bg-white dark:bg-dark-card p-5 sm:p-6 rounded-2xl shadow-sm border ${isFav ? 'border-brand-200 dark:border-brand-900 bg-brand-50/20' : 'border-slate-100 dark:border-slate-700'} cursor-pointer flex flex-col items-center text-center gap-3 transition-all`;
                    card.onclick = () => { playClick(); selectCategory(key); };
                    card.innerHTML = `<button onclick="toggleFavorite(event, '${key}')" class="absolute top-3 right-3 text-slate-300 hover:text-amber-400 transition-colors ${isFav ? 'text-amber-400' : ''}"><i class="fa-solid fa-star text-sm ${isFav ? 'star-active' : ''}"></i></button><div class="w-14 h-14 rounded-2xl ${data.color} bg-opacity-10 dark:bg-opacity-20 text-${data.color.replace('bg-', '')} flex items-center justify-center text-2xl mb-1"><i class="fa-solid ${data.icon}"></i></div><h3 class="font-bold text-slate-800 dark:text-white">${data.title}</h3>`;
                    els.grid.appendChild(card);
                }
            });
        }
        
        function selectCategory(key) {
            state.category = key; const data = unitData[key];
            els.grid.classList.add('hidden'); els.hero.classList.add('hidden'); els.converter.classList.remove('hidden');
            els.activeTitle.innerText = data.title; els.activeIcon.innerHTML = `<i class="fa-solid ${data.icon}"></i>`;
            els.fromUnit.innerHTML = ''; els.toUnit.innerHTML = '';
            const complex = ['fuel','base','roman','color','morse','typography','text','encoding','power','angle','flow','radiation'];
            const units = complex.includes(data.type) ? data.units : (data.type === 'formula') ? ['Celsius', 'Fahrenheit', 'Kelvin'] : (data.type === 'currency') ? data.units : data.units;
            const unitKeys = Array.isArray(units) ? units : Object.keys(units);
            unitKeys.forEach(u => {
                const label = complex.includes(data.type) ? units[u] : formatUnit(u);
                els.fromUnit.add(new Option(label, u)); els.toUnit.add(new Option(label, u));
            });
            els.fromUnit.selectedIndex = 0; els.toUnit.selectedIndex = unitKeys.length > 1 ? 1 : 0;
            els.fromVal.value = (data.type==='color') ? '#FFFFFF' : (data.type==='morse' || data.type==='text') ? 'Hello' : '1';
            calculate(); window.scrollTo({top:0, behavior:'smooth'});
        }

        // --- Core Utils ---
        function formatUnit(s) { return s.replace(/_/g, ' ').replace(/\b\w/g, c=>c.toUpperCase()); }
        function formatNum(n) { if (n===0) return 0; if (Math.abs(n)<1e-6 || Math.abs(n)>1e9) return n.toExponential(4); return parseFloat(n.toPrecision(7)); }
        function formatRes(n) { return (state.precision === 'auto') ? formatNum(n) : (typeof n === 'number' ? n.toFixed(parseInt(state.precision)) : n); }
        function updateCompareTable(val, u1, data) {
             const complex = ['base','roman','color','morse','text','encoding'];
             if (complex.includes(data.type)) { els.compareTable.innerHTML=''; return; }
             let html = '';
             const units = (data.type === 'formula') ? ['Celsius', 'Fahrenheit', 'Kelvin'] : Object.keys(data.units);
             units.forEach(u => {
                if (u === u1) return; let res = 0;
                if (data.type === 'formula') res = convertTemp(val, u1, u);
                else if (data.type === 'fuel') res = convertFuel(val, u1, u);
                else if (data.type === 'typography') { const toPx={px:1,rem:16,em:16,pt:1.333,percent:0.16}; res=(val*toPx[u1])/toPx[u]; }
                else if (data.type === 'currency' || data.type === 'transfer' || !data.type) res = (val / data.units[u1]) * data.units[u];
                const label = (data.type === 'typography') ? data.units[u] : formatUnit(u);
                html += `<div class="flex justify-between items-center py-2 border-b border-slate-100 dark:border-slate-700/50 last:border-0"><span class="text-sm font-medium text-slate-500 dark:text-slate-400">${label}</span><span class="text-sm font-bold text-slate-900 dark:text-white">${formatRes(res)}</span></div>`;
             });
             els.compareTable.innerHTML = html;
        }

        // --- Settings Logic ---
        function toggleThemeMode() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.themeMode = isDark ? 'dark' : 'light';
            els.themeIcon.className = isDark ? 'fa-solid fa-sun text-lg' : 'fa-solid fa-moon text-lg';
            playClick(); 
        }
        function toggleSound() { state.sound = !state.sound; localStorage.setItem('soundEnabled', state.sound); updateToggleBtns(); playClick(); }
        function toggleAmoled() { state.amoled = !state.amoled; localStorage.setItem('amoledMode', state.amoled); document.body.classList.toggle('amoled-mode', state.amoled); updateToggleBtns(); playClick(); }
        function toggleZen() { state.zen = !state.zen; localStorage.setItem('zenMode', state.zen); document.body.classList.toggle('zen-mode', state.zen); updateToggleBtns(); playClick(); }
        function updateToggleBtns() {
            const setBtn = (el, active) => {
                el.className = `w-11 h-6 rounded-full relative transition-colors focus:outline-none ${active ? 'bg-brand-500' : 'bg-slate-200'}`;
                el.firstElementChild.className = `w-4 h-4 bg-white rounded-full absolute top-1 left-1 transition-transform transform ${active ? 'translate-x-5' : ''}`;
            };
            setBtn(els.soundBtn, state.sound); setBtn(els.amoledBtn, state.amoled); setBtn(els.zenBtn, state.zen);
        }
        function toggleFullScreen() { if (!document.fullscreenElement) document.documentElement.requestFullscreen(); else if (document.exitFullscreen) document.exitFullscreen(); }
        function setThemeColor(c) {
            state.theme=c; localStorage.setItem('brandColor',c); playClick();
            const themes={blue:{50:'#eff6ff',100:'#dbeafe',200:'#bfdbfe',500:'#3b82f6',600:'#2563eb',700:'#1d4ed8',900:'#1e3a8a'},purple:{50:'#faf5ff',100:'#f3e8ff',200:'#e9d5ff',500:'#a855f7',600:'#9333ea',700:'#7e22ce',900:'#581c87'},emerald:{50:'#ecfdf5',100:'#d1fae5',200:'#a7f3d0',500:'#10b981',600:'#059669',700:'#047857',900:'#064e3b'},orange:{50:'#fff7ed',100:'#ffedd5',200:'#fed7aa',500:'#f97316',600:'#ea580c',700:'#c2410c',900:'#7c2d12'}};
            const t=themes[c]; Object.keys(t).forEach(k=>document.documentElement.style.setProperty(`--brand-${k}`,t[k]));
        }
        function setPrecision(v) { state.precision = v; localStorage.setItem('precision', v); updatePrecisionBtns(); calculate(true); playClick(); }
        function updatePrecisionBtns() { document.querySelectorAll('.precision-btn').forEach(b => { b.classList.toggle('bg-brand-100', b.dataset.val == state.precision); b.classList.toggle('text-brand-700', b.dataset.val == state.precision); b.classList.toggle('border-brand-500', b.dataset.val == state.precision); }); }
        
        // --- Standard Features ---
        function addToHistory(fV, fU, tV, tU) {
            const data = unitData[state.category];
            const complex = ['fuel','base','roman','color','morse','typography','text','encoding','power','angle','flow','radiation'];
            const u1 = (complex.includes(data.type)) ? data.units[fU] : formatUnit(fU);
            const u2 = (complex.includes(data.type)) ? data.units[tU] : formatUnit(tU);
            const entry = { cat: data.title, txt: `${fV} ${u1} → ${tV} ${u2}`, time: new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'}) };
            if (state.history.length && state.history[0].txt === entry.txt) return;
            state.history.unshift(entry); if (state.history.length > 20) state.history.pop();
            localStorage.setItem('unitHistory', JSON.stringify(state.history)); renderHistory();
        }
        function renderHistory() {
            if (!state.history.length) { els.historyList.innerHTML = '<div class="text-center py-4 text-xs text-slate-400">No recent history</div>'; return; }
            els.historyList.innerHTML = state.history.map(item => `<div class="bg-slate-50 dark:bg-slate-800/50 p-2.5 rounded-xl border border-slate-100 dark:border-slate-700/50"><div class="flex justify-between items-center mb-1"><span class="text-[10px] font-bold text-brand-600 bg-brand-50 dark:bg-brand-900/20 px-1.5 py-0.5 rounded">${item.cat}</span><span class="text-[10px] text-slate-400">${item.time}</span></div><div class="text-xs font-medium text-slate-700 dark:text-slate-300 truncate">${item.txt}</div></div>`).join('');
        }
        function clearHistory() { state.history = []; localStorage.removeItem('unitHistory'); renderHistory(); playClick(); }
        function copyAllHistory() { if(!state.history.length) return; const txt = state.history.map(e => `${e.time} - ${e.txt}`).join('\n'); navigator.clipboard.writeText(txt); showToast('History Copied!'); playClick(); }
        function exportHistory() { if (!state.history.length) return showToast('No data'); const csv = "data:text/csv;charset=utf-8,Time,Conversion\n" + state.history.map(e => `${e.time},${e.txt}`).join("\n"); const link = document.createElement("a"); link.href = encodeURI(csv); link.download = "history.csv"; link.click(); playClick(); }
        function toggleFavorite(e, key) { e.stopPropagation(); playClick(); if (state.favorites.includes(key)) state.favorites = state.favorites.filter(k=>k!==key); else state.favorites.push(key); localStorage.setItem('unitFavorites', JSON.stringify(state.favorites)); renderCategories(els.search.value); showToast(state.favorites.includes(key) ? 'Pinned' : 'Unpinned'); }
        function toggleSettings() { els.settingsModal.classList.toggle('hidden'); playClick(); }
        function toggleCalculator() { state.calculatorOpen = !state.calculatorOpen; els.calcModal.classList.toggle('hidden'); playClick(); }
        function toggleFocusMode() { document.body.classList.toggle('focus-mode'); playClick(); }
        function resetToHome() { state.category = null; els.converter.classList.add('hidden'); els.grid.classList.remove('hidden'); els.hero.classList.remove('hidden'); els.search.value = ''; document.body.classList.remove('focus-mode'); renderCategories(); playClick(); }
        function swapUnits() { const t = els.fromUnit.value; els.fromUnit.value = els.toUnit.value; els.toUnit.value = t; calculate(); playClick(); }
        function useResultAsInput() { const val = els.toVal.value.replace(/,/g, ''); if (!val || val.includes('Invalid')) return; els.fromVal.value = val; calculate(); showToast('Result used as input'); playClick(); }
        function copyToClipboard() { if(!els.toVal.value) return; navigator.clipboard.writeText(els.toVal.value); showToast('Copied!'); playClick(); }
        function showToast(msg) { document.getElementById('toastMsg').innerText = msg; const t = document.getElementById('toast'); t.classList.remove('opacity-0', 'translate-y-10'); setTimeout(() => t.classList.add('opacity-0', 'translate-y-10'), 3000); }
        function speakResult() { if(!els.toVal.value) return; const t = `${els.fromVal.value} ${els.fromUnit.options[els.fromUnit.selectedIndex].text} is ${els.toVal.value} ${els.toUnit.options[els.toUnit.selectedIndex].text}`; const u = new SpeechSynthesisUtterance(t); window.speechSynthesis.speak(u); playClick(); }
        function setupVoice() {
             if ('webkitSpeechRecognition' in window) {
                const r = new webkitSpeechRecognition(); r.continuous = false; r.interimResults = false;
                r.onstart = () => document.getElementById('micBtn').classList.add('text-red-500','animate-pulse');
                r.onend = () => document.getElementById('micBtn').classList.remove('text-red-500','animate-pulse');
                r.onresult = (e) => { const t = e.results[0][0].transcript; const n = parseFloat(t.replace(/,/g,'')); if(!isNaN(n)) { els.fromVal.value = n; calculate(); showToast(`Heard: ${n}`); } };
                window.toggleVoiceInput = () => { try { r.start(); showToast("Listening..."); } catch { r.stop(); } };
            } else { document.getElementById('micBtn').style.display='none'; }
        }
        function setupEvents() {
            els.search.oninput = (e) => renderCategories(e.target.value);
            els.fromVal.oninput = () => calculate(); els.fromUnit.onchange = () => calculate(); els.toUnit.onchange = () => calculate();
            document.onkeydown = (e) => {
                if(e.key==='/' && !state.category) { e.preventDefault(); els.search.focus(); }
                if(e.key==='Escape') { if(state.category) resetToHome(); els.settingsModal.classList.add('hidden'); document.body.classList.remove('focus-mode'); }
                if(e.shiftKey && e.key.toLowerCase()==='c') toggleCalculator();
                if(e.altKey && e.key.toLowerCase()==='s') swapUnits();
                if(state.category && e.key === 'Enter') calculate();
            };
            window.calcAppend=(v)=>{els.calcDisplay.value=(els.calcDisplay.value==='0')?v:els.calcDisplay.value+v;playClick();};
            window.calcClear=()=>{els.calcDisplay.value='0';playClick();};
            window.calcResult=()=>{try{els.calcDisplay.value=eval(els.calcDisplay.value);}catch{els.calcDisplay.value='Error';}playClick();};
        }
        init();
    </script>
</body>
</html>
